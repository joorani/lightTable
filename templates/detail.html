<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- jinja이용해서 title가져오기 -->
    <title>Title</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    <!--font-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu&family=Hahmlet:wght@400;700;900&family=Poor+Story&display=swap"
          rel="stylesheet">

    <style>
        * {
            font-family: 'Hahmlet', serif;
        }

        /*header*/
        .wrap {
            width: 1500px;
            margin: auto;
        }

        .header {
            margin-top: 10px;
        }

        .top {
            display: flex;
            justify-content: space-between;
        }

        .top > div {
            margin: auto 20px;
            font-size: 30px;
        }

        .top > img {
            width: 340px;
            height: 150px;
            display: flex;
            justify-content: left;
        }

        /*상세페이지*/
        .detail_win {
            background-color: #efffdf;
            /*border: black 1px solid;*/
            border-radius: 20px;
            padding: 30px;
        }

        .title {
            width: 95%;
            height: 600px;
            /*border: black 1px solid;*/
            margin: 30px auto 10px;
            display: flex;
            flex-direction: column
        }

        .title > img {
            width: 900px;
            height: 500px;
            border: 1px solid black;
            margin: auto;

        }

        .title > p {
            display: block;
            font-size: 40px;
            margin: auto;
        }

        hr {
            border: 1px solid green;
            width: 95%;
        }

        .ingredients_box {
            width: 95%;
            border: 1px solid black;
            border-radius: 10px;
            padding: 20px;
            margin: auto;;
        }

        .ingredients_box > h3 {
            display: block;
            width: 200px;
            margin: auto;
        }

        .ingredients_box > .ingredients {
            display: flex;
            justify-content: space-around;
            margin: 30px;
        }

        .ingredients_box > .ingredients > div {
            font-size: 25px;
        }

        .recipe_order {
            width: 95%;
            border: 1px solid black;
            border-radius: 10px;
            padding: 50px;
            margin: 20px auto;
        }

        .recipe_order > p {
            font-size: 20px;
        }

        /*코멘트 박스*/
        .comment_box {
            background-color: #efffdf;
            /*border: black 1px solid;*/
            border-radius: 20px;
            margin-top: 20px;
            padding: 30px;
        }

    </style>
</head>

<body>
<div class="wrap">
    <div class="header">
        <div class="top">
            <img src="/static/가벼운식탁%20logo1.png" alt="logo">

            <!-- jinja이용해서 이름가져오기 -->
            <div>ㅇㅇ님 안녕하세요😃</div>
        </div>
    </div>
    <div class="detail_win">
        <div class="title">
            <!--jinja로 title, img_url 가져오기-->
            <img src="" alt="img">
            <p>title</p>
        </div>
        <hr>
        <div class="recipe">
            <div class="ingredients_box">
                <h3>재료 준비!</h3>
                <div class="ingredients">
                    <div>재료</div>
                    <div>재료</div>
                    <div>재료</div>
                    <div>재료</div>
                    <div>재료</div>
                </div>
            </div>
            <div class="recipe_order">
                <p>1. 순서1</p>
                <p>2. 순서3</p>
                <p>3. 순서3</p>
                <p>4. 순서4</p>
            </div>
        </div>
    </div>

{#댓글 적는 칸/////////////////////////////////////////////////////////////#}
    <section class="section">
        <article class="media">
            <div class="media-content">
                <div class="field comment_box">
                    <p class="control">
                        <input id="input-post" class="input is-rounded" placeholder="댓글을 입력하세요"
                               onclick='$("#modal-post").addClass("is-active")'></p>
                </div>
            </div>
        </article>
        <div class="modal" id="modal-post">
            <div class="modal-background" onclick='$("#modal-post").removeClass("is-active")'></div>
            <div class="modal-content">
                <div class="box">
                    <article class="media">
                        <div class="media-content">
                            <div class="field">
                                <p class="control">
                                        <textarea id="textarea-post" class="textarea"
                                                  placeholder="댓글을 입력하세요"></textarea>
                                </p>
                            </div>
                            <nav class="level is-mobile">
                                <div class="level-left">

                                </div>
                                <div class="level-right">
                                    <div class="level-item">
                                        <a class="button is-sparta" onclick="post()">등록하기</a>
                                    </div>
                                    <div class="level-item">
                                        <a class="button is-sparta is-outlined"
                                           onclick='$("#modal-post").removeClass("is-active")'>취소</a>
                                    </div>
                                </div>
                            </nav>
                        </div>
                    </article>
                </div>
            </div>
            <button class="modal-close is-large" aria-label="close"
                    onclick='$("#modal-post").removeClass("is-active")'></button>
        </div>
    </section>
    <section class="section">
        <div id="post-box" class="container">
            <div class="box">
                <article class="media">
                    <div class="media-content">
                        <div class="content">
                            <p>
                                <strong>이름</strong> <small>@username</small> <small>10분 전</small>
                                <br>
                                남긴 댓글
                            </p>
                        </div>
                        <nav class="level is-mobile">
                            <div class="level-left">
                                <a class="level-item is-sparta" aria-label="heart" onclick="toggle_like('', 'heart')">
                                    <span class="icon is-small"><i class="fa fa-heart" aria-hidden="true"></i></span>&nbsp;<span
                                        class="like-num">0</span>
                                </a>
                            </div>

                        </nav>
                    </div>
                </article>
            </div>

        </div>
    </section>

</div>
<script>
    $(document).ready(function () {
        // getTitle()
        comment_listing();
    });

    // function getTitle() {
    //     let titleHref = window.location.href;
    //     let getTitle = titleHref.split('=');	//getarea를 '='를 기준으로 두 배열 요소로 분리
    //     let titleData = getTitle[1];	//분리한 배열 중 두번째 요소 변수에 넣기
    //     // console.log(getTitle)
    //     // console.log(titleData)
    //     let tileAddress = decodeURI(titleData)
    //     detailWin(tileAddress)
    // }

    // function detailWin(data) {
    //     $('#ct1').empty();
    //     $.ajax({
    //         type: "GET",
    //         url: "/detail",
    //         data: {"title": data}, //수정필요
    //         success: function (response) {
    //             let detailWin = response['getdetailWin']
    //             // console.log(detailWin)
    //             let img = detailWin['img_url']
    //             let title = detailWin['title']
    //
    //             let temp_html = ``
    //
    //             $('#ct1').append(temp_html)
    //
    //         }
    //     })
    //
    // }

    {#            ///////////////// 좋아요 입력값인지 출력값인지 보고 반대로 모양변경하기#}
            function toggle_like(post_id, type) {
                console.log(post_id, type)
                let $a_like = $(`#${post_id} a[aria-label='heart']`)
                let $i_like = $a_like.find("i")
                if ($i_like.hasClass("fa-heart")) {
                    $.ajax({
                        type: "POST",
                        url: "/update_like",
                        data: {
                            post_id_give: post_id,
                            type_give: type,
                            action_give: "unlike"
                        },
                        success: function (response) {
                            console.log("unlike")
                            $i_like.addClass("fa-heart-o").removeClass("fa-heart")
                            $a_like.find("span.like-num").text(response["count"])
                        }
                    })
                } else {
                    $.ajax({
                        type: "POST",
                        url: "/update_like",
                        data: {
                            post_id_give: post_id,
                            type_give: type,
                            action_give: "like"
                        },
                        success: function (response) {
                            console.log("like")
                            $i_like.addClass("fa-heart").removeClass("fa-heart-o")
                            $a_like.find("span.like-num").text(response["count"])
                        }
                    })

                }
            }

            {#            ///////////////////////댓글과 날짜 받아오기#}
            function post() {
                let comment = $("#textarea-post").val()
                let today = new Date().toISOString()
                let title = $('#recipe_title").val()
                $.ajax({
                    type: "POST",
                    url: "/posting",
                    data: {
                        comment_give: comment,
                        date_give: today,
                        title_give: title
                    },
                    success: function (response) {
                        $("#modal-post").removeClass("is-active")
                        window.location.reload()
                    }
                })
            }

            {#//////////////얼마전에 작성한 댓글인지 계산하기#}
                function time2str(date) {
                    let today = new Date()
                    let time = (today - date) / 1000 / 60  // 분

                    if (time < 60) {
                        return parseInt(time) + "분 전"
                    }
                    time = time / 60  // 시간
                    if (time < 24) {
                        return parseInt(time) + "시간 전"
                    }
                    time = time / 24
                    if (time < 7) {
                        return parseInt(time) + "일 전"
                    }
                    return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`
                }

    {#저장된 댓글 리미트까지 받아오기//////////////#}
    function get_posts() {
        $("#post-box").empty()
        $.ajax({
            type: "GET",
            url: "/get_posts",
            data: {},
            success: function (response) {
                if (response["result"] == "success") {
                    let posts = response["posts"]
                    for (let i = 0; i < posts.length; i++) {
                        let post = posts[i]
                        let time_post = new Date(post["date"])
                        let time_before = time2str(time_post)
                        let class_heart = post['heart_by_me'] ? "fa-heart" : "fa-heart-o"
                        let count_heart = post['count_heart']
                        let html_temp = `<div class="box" id="${post["_id"]}">
                                                    <article class="media">
                                                        <div class="media-left">
                                                            <a class="image is-64x64" href="/user/${post['username']}">
                                                                <img class="is-rounded" src="/static/${post['profile_pic_real']}"
                                                                     alt="Image">
                                                            </a>
                                                        </div>
                                                        <div class="media-content">
                                                            <div class="content">
                                                                <p>
                                                                    <strong>${post['profile_name']}</strong> <small>@${post['username']}</small> <small>${time_before}</small>
                                                                    <br>
                                                                    ${post['comment']}
                                                                </p>
                                                            </div>
                                                            <nav class="level is-mobile">
                                                                <div class="level-left">
                                                                    <a class="level-item is-sparta" aria-label="heart" onclick="toggle_like('${post['_id']}', 'heart')">
                                                                        <span class="icon is-small"><i class="fa ${class_heart}"
                                                                                                       aria-hidden="true"></i></span>&nbsp;<span class="like-num">${count_heart}</span>
                                                                    </a>
                                                                </div>

                                                            </nav>
                                                        </div>
                                                    </article>
                                                </div>`
                        $("#post-box").append(html_temp)
                    }
                }
            }
        })
    }

    {#페이지 시작하자마자 댓글 열기#}
            $(document).ready(function () {
                get_posts()
            })

</script>
</body>
</html>
